# 第一章 分布式架构
## 集中式到分布式
+ 分布式: 一个硬件或者软件分布在不同的网络计算机上，彼此间仅仅通过消息进行通信和协调的系统
+ CAP定律: 分布式系统不可能全部满足，最多只能满足其中的两点
    - 一致性(Consistency): 多个系统之间的数据保持一致
    - 可用性(availability): 每个操作请求都能在有限时间内返回结果
    - 分区容错性(partition tolerance): 一部分机器故障，但是分布式系统对外仍为正常
+ BASE理论:
    - 基本可用(basically available): 系统出现故障时允许损失部分的可用性(响应时间损失、功能损失)
    - 软状态(soft state): 允许系统中的数据存在中间状态，也就是数据在不同机器上可以存在一定的延时
    - 最终一致性(eventually consistent):所有的数据经过一段时间的同步，最终数据会保持一致
        - 因果一致性
        - 读已之一致性
        - 会话一致性
        - 单调读一致性
        - 单调写一致性
# 第二章 一致性协议
分布式系统中一个机器无法知道其他机器的事务提交情况，需要引入Coordinator和Participant来决定是否把事务真正的提交
## 2PC (two phase commit)
+ 阶段一: 提交事务请求
    - 事务询问： 协调者向所有参与者发送事务内容，询问是否可以执行事务提交操作，并等待参与者的响应
    - 执行事务: 各参与者执行事务操作，并将Undo和Redo操作记录到事务中
    - 参与者反馈事务询问的响应: 
+ 阶段二: 执行事务提交
    - 发送提交请求: 向所有参与者节点发出Commit请求
    - 事务提交:参与者接收到commit请求后，会正式执行事务提交操作，并在提交完成后释放整个事务执行期间所占用的事务资源
    - 反馈事务提交结果: 参与者在完成事务提交后，想协调者发送ack确认消息
    - 完成事务:协调者接收到所有参与者反馈的ack确认消息，完成事务
+ 优点: 简单   
+ 存在的问题: 同步阻塞、单点问题、脑裂、太过保守    
    - 同步阻塞: 二阶段执行过程中，所有的参与者都处于阻塞的状态，已完成的参与者需要等待其他参与者的提交完成
    - 单点问题: 协调者出现问题导致参与者尚未完成的都会出现问题
    - 数据不一致性: 因为网络问题Commit部分机器没有收到消息导致数据不一致
    - 太过保守: 任意一个节点出错，整个分布式系统都会出错
## 3PC
+ 阶段一:CanCommit
    - 事务询问
    - 各参与者反馈是否可以提交事务
+ 阶段二: PreCommit(正常执行事务提交、中断事务)
    - 发送预提交请求
    - 事务预提交
    - 各参与者想协调者反馈事务执行的响应
    - 中断事务: 发送中断请求，参与者收到abort指令或者等待指令的时间内超时直接中断事务
+ 阶段三
    - 发送提交请求
    - 事务提交
    - 反馈事务完成结果
    - 完成事务
    - 中断事务: 发送中断请求，参与者收到abort指令或者等待指令的时间内超时直接中断事务
+ 优点: 相对于2PC来说，降低了参与者的阻塞范围，并且能够在出现单点故障之后继续保持一致性  
存在的问题:在preCommit阶段因为网络问题还是可能导致数据的不一致性

# 第三章 Paxos的工程实践
## Chubby
是一个分布式锁服务，Chubby